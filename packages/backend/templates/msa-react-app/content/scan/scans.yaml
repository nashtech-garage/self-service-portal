trigger: none

parameters:
  - name: sourceAlias
    default: ${{ values.parameters.sourceRepoAlias }}
  {%- if values.parameters.useSonarCode %}
  - name: runSonarCode
    type: boolean
    default: true
    displayName: Run SonarQube Scan
  {%- endif %}
  {%- if values.parameters.useTrivyCode %}
  - name: runTrivyCode
    type: boolean
    default: true
    displayName: Run Trivy Code Scan
  {%- endif %}
  {%- if values.parameters.useSnykCode %}
  - name: runSnykCode
    type: boolean
    default: true
    displayName: Run Snyk Code Scan
  {%- endif %}
  {%- if values.parameters.useSnykImage %}
  - name: runSnykImage
    type: boolean
    default: true
    displayName: Scan Image with Snyk
  {%- endif %}
  {%- if values.parameters.useTrivyImage %}
  - name: runTrivyImage
    type: boolean
    default: true
    displayName: Scan Image with Trivy
  {%- endif %}

resources:
  repositories:
    - repository: ${{ values.parameters.sourceRepoAlias }}
      type: git
      name: ${{ values.parameters.sourceRepoName }}
      ref: ${{ values.parameters.scanBranch }}

stages:
  {%- if values.parameters.useSnykCode %}
  - stage: SnykCodeScan
    dependsOn: []
    jobs:
      - template: snyk.yaml
        parameters:
          {% raw %}source: ${{ parameters.sourceAlias }}{% endraw %}
          serviceConnectionEndpoint: ${{ values.parameters.snykCodeConfig.serviceConnectionEndpoint }}
          {% if values.parameters.useTrivyCode %}scanCode: true{%- endif %}
          {% if values.parameters.useTrivyImage %}scanImage: true{%- endif %}
          scanCode: true
    variables:
      - group: ${{ values.parameters.snykCodeVariableGroupName }}
  {%- endif %}
  
  {%- if values.parameters.useSonarCode %}
  - stage: SonarScan
    dependsOn: []
    jobs:
      - template: sonar.yaml
        parameters:
          {% raw %}source: ${{ parameters.sourceAlias }}{% endraw %}
          SonarQube: ${{ values.parameters.sonarCodeConfig.SonarQube }}
          {% raw %}enabled: ${{ parameters.runSonarCode }}{% endraw %}
    variables:
      - group: ${{ values.parameters.sonarCodeVariableGroupName }}
  {%- endif %}

  {%- if values.parameters.useTrivyCode or values.parameters.useTrivyImage %}
  - stage: TrivyScan
    dependsOn: []
    jobs:
      - template: trivy.yaml
        parameters:
          {% raw %}source: ${{ parameters.sourceAlias }}{% endraw %}
          {% if values.parameters.useTrivyCode %}scanCodeTrivy: true{%- endif %}
          {% if values.parameters.useTrivyImage %}scanImageTrivy: true{%- endif %}
    variables:
      - group: ${{ values.parameters.trivyCodeVariableGroupName }}
  {%- endif %}
