parameters:
  - name: source
    type: string
  - name: scanCode
    type: boolean
    default: false
  - name: scanImage
    type: boolean
    default: false
  - name: serviceConnectionEndpoint
    type: string
jobs:
  - job: snykScanCode
    displayName: Snyk Scan Code
    {% raw %}condition: eq('${{ parameters.scanCode }}', true){% endraw %}
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      {% raw %}- checkout: ${{ parameters.source }}{% endraw %}
      - task: SnykSecurityScan@1
        inputs:
          {% raw %}serviceConnectionEndpoint: ${{ parameters.serviceConnectionEndpoint }}{% endraw %}
          testType: 'code'
          {%- if values.parameters.snykCodeConfig.testType == 'app' %}
          targetFile: $(targetFile)
          monitorWhen: $(monitorWhen)
          {%- endif %}
          {%- if values.parameters.snykCodeConfig.testType == 'container' %}
          dockerImageName: $(dockerImageName)
          dockerfilePath: $(dockerfilePath)
          monitorWhen: $(monitorWhen)
          {%- endif %}
          failOnIssues: $(failOnIssues)
          projectName: $(projectName)
          organization: $(organization)
          additionalArguments: $(additionalArguments)

  - job: snykScanImage
    displayName: Snyk scan image
    {% raw %}condition: eq('${{ parameters.scanImage }}', true){% endraw %}
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      {% raw %}- checkout: ${{ parameters.source }}{% endraw %}
      {%- if values.parameters.snyKDotnetConfig.configMode == 'manual' %}
        - task: SnykSecurityScan@1
          inputs:
            serviceConnectionEndpoint: $(serviceConnectionEndpoint)
            testType: $(testType)
            dockerImageName: $(dockerImageName)
            monitorWhen: $(monitorWhen)
            failOnIssues: $(failOnIssues)
            projectName: $(projectName)
            organization: $(organization)
      {%- endif %}
